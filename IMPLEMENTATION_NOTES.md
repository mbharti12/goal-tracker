# Implementation Notes

## 1) Current goal scoring flow
- Tag events are created via `POST /days/{date}/tag-events` (payload `TagEventCreate`: `tag_id` or `tag_name`, `count`, `ts`, `note`) and stored as `TagEvent` rows. `backend/app/routers/days.py`, `backend/app/schemas.py`, `backend/app/models.py`
- Scoring loads active goals, goal tag weights, goal conditions, and day conditions. It sums tag event counts over the goal's target window (day/week/month), multiplies by tag weight, and compares to `target_count` to set `status` (`met`/`partial`/`missed`/`na`). `scoring_mode` is stored but not used in the current logic. `backend/app/services/scoring.py`, `backend/app/models.py`
- `GET /days/{date}` returns `DayRead` with `day_entry`, `conditions`, `tag_events`, and `goals` (dicts from scoring: `goal_id`, `goal_name`, `applicable`, `status`, `progress`, `target`, `target_window`). `backend/app/routers/days.py`, `backend/app/schemas.py`, `backend/app/services/scoring.py`

## 2) Frontend button-click actions + loading/error patterns
- Today: date navigation buttons update `selectedDate`; actions live in `handleToggleCondition`, `handleAddTagEvent`, `handleCreateTagAndAdd`, `handleDeleteTagEvent`, and debounced `saveNote`. Errors roll into a banner with retry callbacks; loading states are per-card via `useDay`, `useConditions`, `useTags`. `frontend/src/pages/Today.tsx`, `frontend/src/hooks/useDay.ts`, `frontend/src/hooks/useConditions.ts`, `frontend/src/hooks/useTags.ts`, `frontend/src/api/endpoints.ts`
- Goals: actions live in `handleSubmit` (create/update), `handleDeactivate`, `handleCreateTag`, `handleArchiveTag`, `handleUnarchiveTag`, and goal selection/new-goal buttons. Loading/errors are shown per panel with retry buttons and `status--loading/error` blocks from `useGoals`, `useTags`, `useConditions`. `frontend/src/pages/Goals.tsx`, `frontend/src/hooks/useGoals.ts`, `frontend/src/hooks/useTags.ts`, `frontend/src/hooks/useConditions.ts`
- Calendar: month nav buttons update `activeMonth`; day tiles navigate to `/today` and set the date. Data loads via `getCalendarSummary` with local `loading/error` state and a retry button (currently wired to `setReloadToken`, which is not defined in this file). `frontend/src/pages/Calendar.tsx`, `frontend/src/api/endpoints.ts`
- Review: actions live in `handlePreview` (calls `/review/filter`, with a `getCalendar`+`getDay` fallback), `handleManualSummary`, and `handlePromptOnly`. Loading/error states are tracked separately for preview, AI query, and LLM health checks, with retry buttons for conditions/goals lists. `frontend/src/pages/Review.tsx`, `frontend/src/hooks/useGoals.ts`, `frontend/src/hooks/useConditions.ts`, `frontend/src/api/endpoints.ts`

## 3) v3 scoring + trends architecture
- Goal definitions now version over time (`GoalVersion`, `GoalVersionTag`, `GoalVersionCondition`) with backfill during `init_db` to ensure every goal has a baseline version. `backend/app/models.py`, `backend/app/db.py`, `backend/app/services/goal_service.py`
- Scoring resolves the effective goal version for each date and uses version-specific targets/tags/conditions while keeping the response shape intact (plus `goal_version_id`). `backend/app/services/scoring.py`, `backend/app/schemas.py`
- Trend series generation is centralized in `trend_service.build_trend_series`, which bulk-loads tag events, ratings, day conditions, and version metadata to compute per-date points without per-day scoring loops. `backend/app/services/trend_service.py`
- Trend APIs live under `/goals/{id}/trend` and `/trends/compare`, with Pearson correlation computed across aligned ratios. `backend/app/routers/trends.py`, `backend/app/schemas.py`
- Reminder runs now include trend notifications (daily average drop + weekly/monthly pace) with per-day dedupe keys. `backend/app/services/reminder_service.py`
